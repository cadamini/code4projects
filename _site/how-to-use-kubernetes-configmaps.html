<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>How I use Kubernetes ConfigMaps to manage configurations</title>
    <link rel="stylesheet" href="/code4projects/assets/css/styles.css">
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/code4projects/feed.xml" title="Code4Projects" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How I use Kubernetes ConfigMaps to manage configurations | Code4Projects</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="How I use Kubernetes ConfigMaps to manage configurations" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="What I have learned after 30 years of programming" />
<meta property="og:description" content="What I have learned after 30 years of programming" />
<link rel="canonical" href="http://localhost:4000/code4projects/how-to-use-kubernetes-configmaps.html" />
<meta property="og:url" content="http://localhost:4000/code4projects/how-to-use-kubernetes-configmaps.html" />
<meta property="og:site_name" content="Code4Projects" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How I use Kubernetes ConfigMaps to manage configurations" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"What I have learned after 30 years of programming","headline":"How I use Kubernetes ConfigMaps to manage configurations","url":"http://localhost:4000/code4projects/how-to-use-kubernetes-configmaps.html"}</script>
<!-- End Jekyll SEO tag -->

    
  </head>
  <body>
    <header>
  <div id="logo"></div>
  <div id="empty-header"></div>
  <div id="social-area"></div>
</header>

    <div id="menu">
        <nav>
  
    <a href="/code4projects/" >Home</a>
  
    <a href="/code4projects/about.html" >About</a>
  
    <a href="/code4projects/blog.html" >Blog</a>
  
    <a href="/code4projects/staff.html" >Staff</a>
  
</nav>

    </div>
    <div id="content">
        <h1 id="how-i-use-kubernetes-configmaps-to-manage-configurations">How I use Kubernetes ConfigMaps to manage configurations</h1>

<p>This is the third article of the <a href="/code4projects/">Getting Started with Kubernetes</a> series. Here I would like to explain how to manage application configuration with Kubernetes <strong>ConfigMaps</strong>.</p>

<h2 id="the-anatomy-of-an-application">The “Anatomy” of an Application</h2>

<p>Whatever application has usually three layers:</p>

<ol>
  <li>Presentation</li>
  <li>Logic</li>
  <li>Data</li>
</ol>

<p>Presentation and Logic usually are in the binary code that should never change from one deployment to another. What usually changes is the data. With the term data, we essentially mean the data itself and the configuration. For an application that follows the <a href="https://12factor.net/">12-Factor guidelines</a>, it is essentials that configuration is separated by binary code and data.</p>

<p>IMAGE</p>

<p>Photo from https://www.wots.mobi/</p>

<p>Kubernetes manages configuration with ConfigMaps. In the next sections, I will explain what a ConfigMap is, how to create and use it in your applications, how to mount it in volumes, or use them as environment variables.</p>

<p>##What is a ConfigMap in Kubernetes?</p>

<p>In this article, I defined a <strong>ConfigMap</strong> as a key-value dictionary you can create and add to a Kubernetes cluster whose Pods can reference later.</p>

<h2 id="why-would-you-use-a-configmap-in-kubernetes">Why would you use a ConfigMap in Kubernetes?</h2>

<p>According to the <a href="https://12factor.net/">12 Factor app</a>, good application design separate configuration from the data and binary code. Kubernetes uses ConfigMaps to achieve this result. A ConfigMap stores configuration settings for your code, it stores connection strings, public credentials, hostnames, URLs, and much more.</p>

<p>The benefit of this separation is that you can associate multiple ConfigMaps to a Pod for different deployments (development, staging, production, etc.) or even change it at runtime without any code change or new deployments.</p>

<h2 id="how-does-configmap-work">How does ConfigMap work?</h2>

<p>The following steps summarize how ConfigMap works in Kubernetes and the figure below shows the process graphically:</p>

<ul>
  <li>Create multiple ConfigMaps, one for each environment.</li>
  <li>Add a ConfigMap to the Kubernetes cluster.</li>
  <li>Containers in the Pod reference the ConfigMap and use its values.</li>
</ul>

<p>IMAGE</p>

<p>Photo from https://matthewpalmer.net/</p>

<h2 id="how-to-create-and-add-configmaps-to-clusters">How to create and add ConfigMaps to clusters?</h2>

<h3 id="using-yaml-file">Using YAML file</h3>

<p>In <a href="(/code4projects/)">this article</a>, I showed how to define a ConfigMap for an application that contains database connection parameters for database services. Here the example:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
    <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">db-config</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">data</span><span class="pi">:</span>
        <span class="na">connection.properties</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">db.name=mydb</span>
            <span class="s">db.port=5432</span>
            <span class="s">db.user=myuser</span>
            <span class="s">db.password=mypassword</span>
    </code></pre></figure>

<p>You can use the following command to create the ConfigMap from the YAML file in the default namespace:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    kubectl apply <span class="nt">-f</span> YAML
    </code></pre></figure>

<p>As we know from the <a href="/code4projects/">first article</a>, namespaces are the way Kubernetes manages multiple virtual clusters on a single physical cluster. In our example, we add the ConfigMap to the default namespace.</p>

<h3 id="using-command-line">Using command line</h3>

<p>If you have a folder DIR with one or more configuration file or a single file <em>FILE</em>, you can create a ConfigMap from them with kubectl command line:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    kubectl create configmap NAME <span class="nt">--from-file</span><span class="o">=</span>DIR or FILE <span class="nt">--namespace</span><span class="o">=</span>default
    </code></pre></figure>

<p>On both the examples, if you don’t specify a namespace (–namespace is an optional parameter) the ConfigMap is associated with the default one.</p>

<p>There is another way to create ConfigMaps using the <code class="language-plaintext highlighter-rouge">kubectl create configmap</code> command. Use literal key-value pairs defined on the command line with</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">    kubectl create configmap db-config <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">key1</span><span class="o">=</span>value1 <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">key2</span><span class="o">=</span>value2
    </code></pre></figure>

<p>You can get more information about this command using kubectl create configmap –help.</p>

<h2 id="how-pods-reference-configmaps">How Pods reference ConfigMaps?</h2>

<p>In the figure above, you can notice that Pods can reference the ConfigMap in two ways:</p>

<ol>
  <li>Environment variables.</li>
  <li>Mount volumes.</li>
</ol>

<h3 id="how-pods-reference-configmaps-with-environment-variables">How Pods reference ConfigMaps with environment variables?</h3>

<p>There are basically two ways to reference ConfigMaps with environment variables:</p>

<p>Define the environment variable and get its value from the ConfigMap
Load all the key-value pairs from the ConfigMap and use them as environment variables.
The following is a YAML example for the first method, where the value of <em>db.user</em> property in the <em>db-config</em> ConfigMap is assigned to the DB_USER_ENV environment variable:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
    <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">my-pod</span>
    <span class="na">spec</span><span class="pi">:</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-container</span>
        <span class="s">image</span><span class="err">:</span> <span class="s">my-image:x.y.z</span>
        <span class="s">env</span><span class="err">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_USER_ENV</span>
            <span class="s">valueFrom</span><span class="err">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">db-config</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">db.user</span>
    </code></pre></figure>

<p>This is an example of the second method, where all the properties of the db-config ConfigMap are read and used as environment variables:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">    <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span> 
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span> 
    <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">my-pod</span>
    <span class="na">spec</span><span class="pi">:</span>
        <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-container</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-image:x.y.z</span> 
        <span class="na">envFrom</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">configMapRef</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">db-config</span>
    </code></pre></figure>

<h3 id="how-pods-reference-configmaps-with-mount-volumes">How Pods reference ConfigMaps with mount volumes?</h3>

<p>Defining the ConfigMap in YAML and mounting it as a volume is the easiest way to use ConfigMaps.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">    <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span> 
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span> 
    <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">my-pod</span> 
    <span class="na">spec</span><span class="pi">:</span>
    <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">db-config</span>

    <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-container</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-image:x.y.z</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-volume</span>
            <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/config</span>
    </code></pre></figure>

<p>In this example, you can see that the <em>db-config</em> ConfigMap is defined as a volume (<em>my-volume</em>). Then this volume is mounted under the /etc/config folder creating the connection.properties file in it. Create and add this Pod to the cluster using the kubectl apply command (see above). Attach to the created Pod using <code class="language-plaintext highlighter-rouge">kubectl exec -it my-pod sh</code>. Then run <code class="language-plaintext highlighter-rouge">ls /etc/config/</code> and you can see the <em>c</em>onnection.properties* file. Use the cat command to look at the contents of each file and you’ll see the values from the ConfigMap.</p>

<h2 id="whats-next">What’s next?</h2>

<p>In this article, we learned how to manage application configuration using Kubernetes ConfigMap. However, in the connection.properties file we have a password that is sensitive data (db.password). Kubernetes manages them with Secrets, a new concept that we will analyze in the next article.</p>

    </div>
    <div id="course_sidebar">
        <nav>
  <ul>
  
    <li><a href="/code4projects/" >Getting started with Kubernetes</a></li>
  
    <li><a href="/code4projects/kubernetes-services-cluster-ip-vs-nodeport-vs-loadbalancer-vs-ingress.html" >Kubernetes Cluster IP vs NodePort vs LoadBalancer vs Ingress</a></li>
  
    <li><a href="/code4projects/how-to-use-kubernetes-configmaps.html" class="current">How I use Kubernetes ConfigMaps to manage configurations</a></li>
  
    <li><a href="/code4projects/how-to-create-your-own-kubernetes-cluster.html" >How to create your own Kubernetes cluster</a></li>
  
  </ul>
</nav>

    </div>
  </body>
</html>
